<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>ctf-pwn-tips-zh_CN | l0ser</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3BA2A2">
    
    
    <meta name="keywords" content="ctf-pwn">
    <meta name="description" content="Catalog Overflow Find string in gdb Binary Service Find specific function offset in libc Find ‘/bin/sh’ or ‘sh’ in library Leak stack address Fork problem in gdb Secret of a mysterious section - .tls">
<meta name="keywords" content="ctf-pwn">
<meta property="og:type" content="article">
<meta property="og:title" content="ctf-pwn-tips-zh_CN">
<meta property="og:url" content="http://zero-mk.github.io/2018/12/31/CTF-pwn-tips-zh_CN/index.html">
<meta property="og:site_name" content="l0ser">
<meta property="og:description" content="Catalog Overflow Find string in gdb Binary Service Find specific function offset in libc Find ‘/bin/sh’ or ‘sh’ in library Leak stack address Fork problem in gdb Secret of a mysterious section - .tls">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-12-31T18:43:48.810Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ctf-pwn-tips-zh_CN">
<meta name="twitter:description" content="Catalog Overflow Find string in gdb Binary Service Find specific function offset in libc Find ‘/bin/sh’ or ‘sh’ in library Leak stack address Fork problem in gdb Secret of a mysterious section - .tls">
    
        <link rel="alternate" type="application/atom+xml" title="l0ser" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname"></h5>
          <a href="mailto:1565328054@qq.com" title="1565328054@qq.com" class="mail">1565328054@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/zero-MK" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">ctf-pwn-tips-zh_CN</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="検索">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">ctf-pwn-tips-zh_CN</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-12-31T08:39:34.000Z" itemprop="datePublished" class="page-time">
  2018-12-31
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Catalog"><span class="post-toc-number">1.</span> <span class="post-toc-text">Catalog</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Overflow"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">Overflow</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#scanf"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">scanf</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#gets"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">gets</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#read"><span class="post-toc-number">1.1.3.</span> <span class="post-toc-text">read</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#strcpy"><span class="post-toc-number">1.1.4.</span> <span class="post-toc-text">strcpy</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#strcat"><span class="post-toc-number">1.1.5.</span> <span class="post-toc-text">strcat</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Find-string-in-gdb"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Find string in gdb</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#gdb"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">gdb</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#gdb-peda"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">gdb peda</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Binary-Service"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">Binary Service</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Find-specific-function-offset-in-libc"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">Find specific function offset in libc</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Manually"><span class="post-toc-number">1.4.1.</span> <span class="post-toc-text">Manually</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Automatically"><span class="post-toc-number">1.4.2.</span> <span class="post-toc-text">Automatically</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Find-‘-bin-sh’-or-‘sh’-in-library"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">Find ‘/bin/sh’ or ‘sh’ in library</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Manually-1"><span class="post-toc-number">1.5.1.</span> <span class="post-toc-text">Manually</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Automatically-1"><span class="post-toc-number">1.5.2.</span> <span class="post-toc-text">Automatically</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Leak-stack-address"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">Leak stack address</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Fork-problem-in-gdb"><span class="post-toc-number">1.7.</span> <span class="post-toc-text">Fork problem in gdb</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Secret-of-a-mysterious-section-tls"><span class="post-toc-number">1.8.</span> <span class="post-toc-text">Secret of a mysterious section - .tls</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Predictable-RNG-Random-Number-Generator"><span class="post-toc-number">1.9.</span> <span class="post-toc-text">Predictable RNG(Random Number Generator)</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Make-stack-executable"><span class="post-toc-number">1.10.</span> <span class="post-toc-text">Make stack executable</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Use-one-gadget-RCE-instead-of-system"><span class="post-toc-number">1.11.</span> <span class="post-toc-text">Use one-gadget-RCE instead of system</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Hijack-hook-function"><span class="post-toc-number">1.12.</span> <span class="post-toc-text">Hijack hook function</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Use-printf-to-trigger-malloc-and-free"><span class="post-toc-number">1.13.</span> <span class="post-toc-text">Use printf to trigger malloc and free</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#conclusion"><span class="post-toc-number">1.13.1.</span> <span class="post-toc-text">conclusion</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Use-execveat-to-open-a-shell"><span class="post-toc-number">1.14.</span> <span class="post-toc-text">Use execveat to open a shell</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#原文-https-github-com-Naetw-CTF-pwn-tips"><span class="post-toc-number">2.</span> <span class="post-toc-text">原文:https://github.com/Naetw/CTF-pwn-tips</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#译者-l0ser"><span class="post-toc-number">3.</span> <span class="post-toc-text">译者:l0ser</span></a></li></ol>
        </nav>
    </aside>


<article id="post-CTF-pwn-tips-zh_CN"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">ctf-pwn-tips-zh_CN</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-12-31 16:39:34" datetime="2018-12-31T08:39:34.000Z"  itemprop="datePublished">2018-12-31</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="Catalog"><a href="#Catalog" class="headerlink" title="Catalog"></a>Catalog</h1><ul>
<li><a href="http://#overflow" target="_blank" rel="noopener">Overflow</a></li>
<li><a href="#find-string-in-gdb">Find string in gdb</a></li>
<li><a href="#binary-service">Binary Service</a></li>
<li><a href="#find-specific-function-offset-in-libc">Find specific function offset in libc</a></li>
<li><a href="#find-binsh-or-sh-in-library">Find ‘/bin/sh’ or ‘sh’ in library</a></li>
<li><a href="#leak-stack-address">Leak stack address</a></li>
<li><a href="#fork-problem-in-gdb">Fork problem in gdb</a></li>
<li><a href="#secret-of-a-mysterious-section---tls">Secret of a mysterious section - .tls</a></li>
<li><a href="#predictable-rngrandom-number-generator">Predictable RNG(Random Number Generator)</a></li>
<li><a href="#make-stack-executable">Make stack executable</a></li>
<li><a href="#use-one-gadget-rce-instead-of-system">Use one-gadget-RCE instead of system</a></li>
<li><a href="#hijack-hook-function">Hijack hook function</a></li>
<li><a href="#use-printf-to-trigger-malloc-and-free">Use printf to trigger malloc and free</a></li>
<li><a href="#use-execveat-to-open-a-shell">Use execveat to open a shell</a></li>
</ul>
<h2 id="Overflow"><a href="#Overflow" class="headerlink" title="Overflow"></a>Overflow</h2><p>例如:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">40</span>]</span><br><span class="line"><span class="keyword">signed</span> <span class="keyword">int</span> num</span><br></pre></td></tr></table></figure></p>
<h3 id="scanf"><a href="#scanf" class="headerlink" title="scanf"></a>scanf</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">"%s"</span>, buf)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>%s</code> 没有边界检查</li>
<li><strong>pwnable</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">"%39s"</span>, buf)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>39s</code> 只从输入中获取39个字节，并将 NULL 字节放在输入的末尾。</li>
<li><strong>useless</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">"%40s"</span>, buf)</span><br></pre></td></tr></table></figure>
<ul>
<li>乍一看，这似乎是合理的。</li>
<li>它从输入中获取40字节，但它也将NULL字节放在输入的末尾。</li>
<li>但是,它有one-byte-overflow</li>
<li><strong>pwnable</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;num)</span><br><span class="line">alloca(num)</span><br></pre></td></tr></table></figure>
<pre><code>* 由于`alloca`从调用者的堆栈框架分配内存，因此有一条` sub esp, eax `指令来实现这一点。
* 如果我们使num为负，它将有重叠的堆栈帧。
* E.g. [Seccon CTF quals 2016 cheer_msg](https://github.com/ctfs/write-ups-2016/tree/master/seccon-ctf-quals-2016/exploit/cheer-msg-100)
</code></pre><ul>
<li>使用num访问一些数据结构<ul>
<li>大多数情况下，程序只检查较高的边界，忘记使num无符号。</li>
<li>使num为负可以让我们覆盖一些重要的数据</li>
</ul>
</li>
</ul>
<h3 id="gets"><a href="#gets" class="headerlink" title="gets"></a>gets</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gets(buf)</span><br></pre></td></tr></table></figure>
<ul>
<li>没有检查边界</li>
<li><strong>pwnable</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fgets(buf, <span class="number">40</span>, <span class="built_in">stdin</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>它只从输入中获取39个字节，并将NULL字节放在输入的末尾。</li>
<li><strong>useless</strong></li>
</ul>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read(<span class="built_in">stdin</span>, buf, <span class="number">40</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>它从输入中获取40字节，并且不将NULL字节放在输入的末尾。</li>
<li>这看起来很安全，但可能会有 <strong>information leak</strong>.</li>
<li><strong>leakable</strong></li>
</ul>
<p>E.g.</p>
<p><strong>memory layout</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x7fffffffdd00: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x7fffffffdd10: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x7fffffffdd20: 0x4141414141414141      0x00007fffffffe1cd</span><br></pre></td></tr></table></figure></p>
<ul>
<li>如果现在用<code>printf</code>或者<code>puts</code>来输出这个buf,它将一直输出到NULL byte.</li>
<li>在这种情况下，我们可以:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;A&apos;*40 + &apos;\xcd\xe1\xff\xff\xff\x7f&apos;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fread(buf, 1, 40, stdin)</span><br></pre></td></tr></table></figure>
<ul>
<li>几乎和<code>read</code>一样</li>
<li><strong>leakable</strong></li>
</ul>
<h3 id="strcpy"><a href="#strcpy" class="headerlink" title="strcpy"></a>strcpy</h3><p>假设还有另一个缓冲区:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char buf2[60]</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strcpy(buf, buf2)</span><br></pre></td></tr></table></figure>
<ul>
<li>没有边界检查</li>
<li>buf2的大小可能比buf大</li>
<li>所以可能会buffer overflow</li>
<li><strong>pwnable</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">strncpy(buf, buf2, 40)</span><br><span class="line">memcpy(buf, buf2, 40)</span><br></pre></td></tr></table></figure>
<ul>
<li>这个操作会把buf2前40 bytes复制到buf,但是不会再末尾添加NULL byte</li>
<li>因为结尾没有NULL byte, 也许可以 <strong>information leak</strong>.</li>
<li><strong>leakable</strong></li>
</ul>
<h3 id="strcat"><a href="#strcat" class="headerlink" title="strcat"></a>strcat</h3><p>假设有:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char buf2[60]</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strcat(buf, buf2)</span><br></pre></td></tr></table></figure>
<ul>
<li>strcat是将两个char类型连接。</li>
<li>如果buf不够大，可能会导致溢出。</li>
<li>它将NULL byte放在末尾，这可能会导致<strong>one-byte-overflow</strong>.</li>
<li>在某些情况下，我们可以使用这个NULL byte来更改堆栈地址或堆地址。</li>
<li><strong>pwnable</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strncat(buf, buf2, n)</span><br></pre></td></tr></table></figure>
<ul>
<li>和<code>strcat</code>相似, 但是有大小n限制</li>
<li><strong>pwnable</strong></li>
<li>E.g. <a href="https://github.com/ctfs/write-ups-2016/tree/master/seccon-ctf-quals-2016/exploit/jmper-300" target="_blank" rel="noopener">Seccon CTF quals 2016 jmper</a></li>
</ul>
<h2 id="Find-string-in-gdb"><a href="#Find-string-in-gdb" class="headerlink" title="Find string in gdb"></a>Find string in gdb</h2><p>在 <a href="http://j00ru.vexillium.org/blog/24_03_15/dragons_ctf.pdf" target="_blank" rel="noopener">SSP</a>中, 我们需要找出argv[0]和输入缓冲区之间的偏移量。</p>
<h3 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h3><ul>
<li>Use <code>p/x ((char **)environ)</code> in gdb, and the address of argv[0] will be the <code>output - 0x10</code></li>
<li>在gdb中使用<code>p/x ((char **)environ)</code>， argv[0]的地址将是<code>output - 0x10</code></li>
</ul>
<p>E.g.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p/x (char **)environ</span><br><span class="line">$9 = 0x7fffffffde38</span><br><span class="line">(gdb) x/gx 0x7fffffffde38-0x10</span><br><span class="line">0x7fffffffde28: 0x00007fffffffe1cd</span><br><span class="line">(gdb) x/s 0x00007fffffffe1cd</span><br><span class="line">0x7fffffffe1cd: &quot;/home/naetw/CTF/seccon2016/check/checker&quot;</span><br></pre></td></tr></table></figure>
<h3 id="gdb-peda"><a href="#gdb-peda" class="headerlink" title="gdb peda"></a><a href="https://github.com/longld/peda" target="_blank" rel="noopener">gdb peda</a></h3><ul>
<li>使用 <code>searchmem</code>搜索内存<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Usage:</span><br><span class="line">    searchmem pattern start end</span><br><span class="line">    searchmem pattern mapname</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ searchmem &quot;/home/naetw/CTF/seccon2016/check/checker&quot;</span><br><span class="line">Searching for &apos;/home/naetw/CTF/seccon2016/check/checker&apos; in: None ranges</span><br><span class="line">Found 3 results, display max 3 items:</span><br><span class="line">[stack] : 0x7fffffffe1cd (&quot;/home/naetw/CTF/seccon2016/check/checker&quot;)</span><br><span class="line">[stack] : 0x7fffffffed7c (&quot;/home/naetw/CTF/seccon2016/check/checker&quot;)</span><br><span class="line">[stack] : 0x7fffffffefcf (&quot;/home/naetw/CTF/seccon2016/check/checker&quot;)</span><br><span class="line">gdb-peda$ searchmem 0x7fffffffe1cd</span><br><span class="line">Searching for &apos;0x7fffffffe1cd&apos; in: None ranges</span><br><span class="line">Found 2 results, display max 2 items:</span><br><span class="line">   libc : 0x7ffff7dd33b8 --&gt; 0x7fffffffe1cd (&quot;/home/naetw/CTF/seccon2016/check/checker&quot;)</span><br><span class="line">[stack] : 0x7fffffffde28 --&gt; 0x7fffffffe1cd (&quot;/home/naetw/CTF/seccon2016/check/checker&quot;)</span><br></pre></td></tr></table></figure>
<h2 id="Binary-Service"><a href="#Binary-Service" class="headerlink" title="Binary Service"></a>Binary Service</h2><p>不需要使用共享库的binary:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ncat -vc ./binary -kl $ip $port</span><br></pre></td></tr></table></figure>
<p>需要使用共享库的binary:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ncat -vc &apos;LD_PRELOAD=/path/to/libc.so ./binary&apos; -kl $ip $port</span><br><span class="line">ncat -vc &apos;LD_LIBRARY_PATH=/path/of/libc.so ./binary&apos; -kl $ip $port</span><br></pre></td></tr></table></figure>
<p>在此之后，您可以通过nc连接到二进制服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc $ip $port</span><br></pre></td></tr></table></figure></p>
<h2 id="Find-specific-function-offset-in-libc"><a href="#Find-specific-function-offset-in-libc" class="headerlink" title="Find specific function offset in libc"></a>Find specific function offset in libc</h2><p>如果我们成功地泄漏了某个函数的libc地址，我们可以通过用函数在libc地址减去该函数的偏移量来得到libc的基地址。</p>
<h3 id="Manually"><a href="#Manually" class="headerlink" title="Manually"></a>Manually</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -s libc名 | grep 函数名@</span><br></pre></td></tr></table></figure>
<p>E.g.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -s libc-2.19.so | grep system@</span><br><span class="line">    620: 00040310    56 FUNC    GLOBAL DEFAULT   12 __libc_system@@GLIBC_PRIVATE</span><br><span class="line">   1443: 00040310    56 FUNC    WEAK   DEFAULT   12 system@@GLIBC_2.0</span><br></pre></td></tr></table></figure>
<h3 id="Automatically"><a href="#Automatically" class="headerlink" title="Automatically"></a>Automatically</h3><ul>
<li>使用 <a href="https://github.com/Gallopsled/pwntools" target="_blank" rel="noopener">pwntools</a></li>
</ul>
<p>E.g.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">libc = ELF(&apos;libc.so&apos;)</span><br><span class="line">system_off = libc.symbols[&apos;system&apos;]</span><br></pre></td></tr></table></figure>
<h2 id="Find-‘-bin-sh’-or-‘sh’-in-library"><a href="#Find-‘-bin-sh’-or-‘sh’-in-library" class="headerlink" title="Find ‘/bin/sh’ or ‘sh’ in library"></a>Find ‘/bin/sh’ or ‘sh’ in library</h2><p>先得到libc的基地址</p>
<h3 id="Manually-1"><a href="#Manually-1" class="headerlink" title="Manually"></a>Manually</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objdump -s libc.so | less (search &apos;sh&apos;)</span><br><span class="line">strings -tx libc.so | grep /bin/sh</span><br></pre></td></tr></table></figure>
<h3 id="Automatically-1"><a href="#Automatically-1" class="headerlink" title="Automatically"></a>Automatically</h3><ul>
<li>使用 <a href="https://github.com/Gallopsled/pwntools" target="_blank" rel="noopener">pwntools</a></li>
</ul>
<p>E.g.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">libc = ELF(&apos;libc.so&apos;)</span><br><span class="line">...</span><br><span class="line">sh = base + next(libc.search(&apos;sh\x00&apos;))</span><br><span class="line">binsh = base + next(libc.search(&apos;/bin/sh\x00&apos;))</span><br></pre></td></tr></table></figure>
<p>译者注 : next(libc.search(<code>some_characters</code>)) 在libc找到包含 some_characters（字符串，汇编代码或者某个数值）的地址</p>
<h2 id="Leak-stack-address"><a href="#Leak-stack-address" class="headerlink" title="Leak stack address"></a>Leak stack address</h2><p><strong>constraints</strong>:</p>
<ul>
<li>libc的基地地址已经泄露了吗</li>
<li>可以泄露任意地址的内容吗</li>
</ul>
<p>有一个 symbol <code>environ</code> 在libc中,它的值与<code>main</code>函数的第三个参数<code>char **envp</code>相同。<br> char **envp ‘的值在堆栈上，因此我们可以使用这个 symbol泄漏堆栈地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(gdb) list 1</span><br><span class="line">1       #include &lt;stdlib.h&gt;</span><br><span class="line">2       #include &lt;stdio.h&gt;</span><br><span class="line">3</span><br><span class="line">4       extern char **environ;</span><br><span class="line">5</span><br><span class="line">6       int main(int argc, char **argv, char **envp)</span><br><span class="line">7       &#123;</span><br><span class="line">8           return 0;</span><br><span class="line">9       &#125;</span><br><span class="line">(gdb) x/gx 0x7ffff7a0e000 + 0x3c5f38</span><br><span class="line">0x7ffff7dd3f38 &lt;environ&gt;:       0x00007fffffffe230</span><br><span class="line">(gdb) p/x (char **)envp</span><br><span class="line">$12 = 0x7fffffffe230</span><br></pre></td></tr></table></figure>
<ul>
<li>当前的libc基地址是 <code>0x7ffff7a0e000</code></li>
<li><code>environ</code>在libc的偏移量为<code>0x3c5f38</code></li>
</ul>
<p>这本 <a href="https://www.gnu.org/software/libc/manual/html_node/Program-Arguments.html" target="_blank" rel="noopener">手册</a> 详细解释了 <code>environ</code></p>
<h2 id="Fork-problem-in-gdb"><a href="#Fork-problem-in-gdb" class="headerlink" title="Fork problem in gdb"></a>Fork problem in gdb</h2><p>当您使用<code>gdb</code>调试一个带有<code>fork()</code>函数的二进制文件时，您可以使用以下命令来确定要执行哪个进程(原始<code>gdb</code>的默认设置是父进程，而<code>gdb-peda</code>的默认设置是子进程):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set follow-fork-mode parent</span><br><span class="line">set follow-fork-mode child</span><br></pre></td></tr></table></figure>
<p>Alternatively, using <code>set detach-on-fork off</code>, we can then control both sides of each fork. Using <code>inferior X</code> where <code>X</code> is any of the numbers that show up for <code>info inferiors</code> will switch to that side of the fork. This is useful if both sides of the fork are necessary to attack a challenge, and the simple <code>follow</code> ones above aren’t sufficient.<br>或者，使用<code>set detach-on-fork off</code>，我们可以控制每个fork的两边。使用<code>inferior X</code>，其中<code>X</code>是出现在<code>info inferiors</code>中的任何一个数字，都会切换到fork的那一边。如果分支的两端都是攻击某个挑战所必需的，并且上面简单的<code>follow</code>操作还不够，那么这种方法非常有用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ info inferiors</span><br><span class="line">  Num  Description       Executable</span><br><span class="line">* 1    xxxx              xxxxx</span><br><span class="line">  2    xxxx              xxxxx</span><br></pre></td></tr></table></figure></p>
<h2 id="Secret-of-a-mysterious-section-tls"><a href="#Secret-of-a-mysterious-section-tls" class="headerlink" title="Secret of a mysterious section - .tls"></a>Secret of a mysterious section - .tls</h2><p><strong>constraints</strong>:</p>
<ul>
<li>Need <code>malloc</code> function and you can malloc with arbitrary size</li>
<li>Arbitrary address leaking</li>
</ul>
<p>We make <code>malloc</code> use <code>mmap</code> to allocate memory(size 0x21000 is enough). In general, these pages will be placed at the address just before <code>.tls</code> section.</p>
<p>There is some useful information on <strong><code>.tls</code></strong>, such as the address of <code>main_arena</code>, <code>canary</code> (value of stack guard), and a strange <code>stack address</code> which points to somewhere on the stack but with a fixed offset.</p>
<p><strong>Before calling mmap:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">7fecbfe4d000-7fecbfe51000 r--p 001bd000 fd:00 131210         /lib/x86_64-linux-gnu/libc-2.24.so</span><br><span class="line">7fecbfe51000-7fecbfe53000 rw-p 001c1000 fd:00 131210         /lib/x86_64-linux-gnu/libc-2.24.so</span><br><span class="line">7fecbfe53000-7fecbfe57000 rw-p 00000000 00:00 0</span><br><span class="line">7fecbfe57000-7fecbfe7c000 r-xp 00000000 fd:00 131206         /lib/x86_64-linux-gnu/ld-2.24.so</span><br><span class="line">7fecc0068000-7fecc006a000 rw-p 00000000 00:00 0              &lt;- .tls section</span><br><span class="line">7fecc0078000-7fecc007b000 rw-p 00000000 00:00 0</span><br><span class="line">7fecc007b000-7fecc007c000 r--p 00024000 fd:00 131206         /lib/x86_64-linux-gnu/ld-2.24.so</span><br><span class="line">7fecc007c000-7fecc007d000 rw-p 00025000 fd:00 131206         /lib/x86_64-linux-gnu/ld-2.24.so</span><br></pre></td></tr></table></figure>
<p><strong>After call mmap:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">7fecbfe4d000-7fecbfe51000 r--p 001bd000 fd:00 131210         /lib/x86_64-linux-gnu/libc-2.24.so</span><br><span class="line">7fecbfe51000-7fecbfe53000 rw-p 001c1000 fd:00 131210         /lib/x86_64-linux-gnu/libc-2.24.so</span><br><span class="line">7fecbfe53000-7fecbfe57000 rw-p 00000000 00:00 0</span><br><span class="line">7fecbfe57000-7fecbfe7c000 r-xp 00000000 fd:00 131206         /lib/x86_64-linux-gnu/ld-2.24.so</span><br><span class="line">7fecc0045000-7fecc006a000 rw-p 00000000 00:00 0              &lt;- memory of mmap + .tls section</span><br><span class="line">7fecc0078000-7fecc007b000 rw-p 00000000 00:00 0</span><br><span class="line">7fecc007b000-7fecc007c000 r--p 00024000 fd:00 131206         /lib/x86_64-linux-gnu/ld-2.24.so</span><br><span class="line">7fecc007c000-7fecc007d000 rw-p 00025000 fd:00 131206         /lib/x86_64-linux-gnu/ld-2.24.so</span><br></pre></td></tr></table></figure>
<h2 id="Predictable-RNG-Random-Number-Generator"><a href="#Predictable-RNG-Random-Number-Generator" class="headerlink" title="Predictable RNG(Random Number Generator)"></a>Predictable RNG(Random Number Generator)</h2><p>When the binary uses the RNG to make the address of important information or sth, we can guess the same value if it’s predictable.</p>
<p>Assuming that it’s predictable, we can use <a href="https://docs.python.org/2/library/ctypes.html" target="_blank" rel="noopener">ctypes</a> which is a build-in module in Python.</p>
<p><strong>ctypes</strong> allows calling a function in DLL(Dynamic-Link Library) or Shared Library.</p>
<p>Therefore, if binary has an init_proc like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">srand(time(NULL));</span><br><span class="line">while(addr &lt;= 0x10000)&#123;</span><br><span class="line">    addr = rand() &amp; 0xfffff000;</span><br><span class="line">&#125;</span><br><span class="line">secret = mmap(addr,0x1000,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS ,-1,0);</span><br><span class="line">if(secret == -1)&#123;</span><br><span class="line">    puts(`mmap error`);</span><br><span class="line">    exit(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then we can use <strong>ctypes</strong> to get the same value of addr.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import ctypes</span><br><span class="line">LIBC = ctypes.cdll.LoadLibrary(&apos;/path/to/dll&apos;)</span><br><span class="line">LIBC.srand(LIBC.time(0))</span><br><span class="line">addr = LIBC.rand() &amp; 0xfffff000</span><br></pre></td></tr></table></figure>
<h2 id="Make-stack-executable"><a href="#Make-stack-executable" class="headerlink" title="Make stack executable"></a>Make stack executable</h2><ul>
<li><a href="http://radare.today/posts/defeating-baby_rop-with-radare2/" target="_blank" rel="noopener">link1</a></li>
<li><a href="https://sploitfun.wordpress.com/author/sploitfun/" target="_blank" rel="noopener">link2</a></li>
<li>Haven’t read yet orz</li>
</ul>
<h2 id="Use-one-gadget-RCE-instead-of-system"><a href="#Use-one-gadget-RCE-instead-of-system" class="headerlink" title="Use one-gadget-RCE instead of system"></a>Use one-gadget-RCE instead of system</h2><p><strong>constraints</strong>:</p>
<ul>
<li>有libc的基本地址</li>
<li>任意地址写</li>
</ul>
<p>几乎每个pwnable挑战都需要在攻击结束时调用<code>system(&quot;/bin/sh&quot;)</code>，但是如果我们想调用它，我们必须操纵参数，当然，还需要劫持一些函数来调用’<code>system</code>。如果我们不能操纵参数怎么办?</p>
<p>使用 <a href="http://j00ru.vexillium.org/blog/24_03_15/dragons_ctf.pdf" target="_blank" rel="noopener">one-gadget-RCE</a>!</p>
<p>用 <strong>one-gadget-RCE</strong>, 我们就劫持 <code>.got.plt</code> 或者我们可以用它来控制eip 使程序跳转到 <strong>one-gadget</strong>, 但是在使用它之前需要满足一些constraint<br>libc中有很多<strong>one-gadgets</strong>. 每个都有不同的constraints，但它们是相似的。每个constraints都与寄存器的状态有关。</p>
<p>E.g.</p>
<ul>
<li>ebx 在libc里的地址是 <code>rw-p</code> 的</li>
<li><code>[esp+0x34] == NULL</code></li>
</ul>
<p>我们如何得到这些constraints? 这里有一个有效的工具 <a href="https://github.com/david942j/one_gadget" target="_blank" rel="noopener">one_gadget</a> !!!!</p>
<p>如果我们能满足这些constraints, 我们就可以轻易getshell</p>
<h2 id="Hijack-hook-function"><a href="#Hijack-hook-function" class="headerlink" title="Hijack hook function"></a>Hijack hook function</h2><p><strong>constraints</strong>:</p>
<ul>
<li>有libc基地址</li>
<li>任意地址写</li>
<li>程序有用到 <code>malloc</code>, <code>free</code> or <code>realloc</code></li>
</ul>
<p>By manual:</p>
<blockquote>
<p>原文:<br>The GNU C Library lets you modify the behavior of <code>malloc</code>, <code>realloc</code>, and <code>free</code> by specifying appropriate hook functions. You can use these hooks to help you debug programs that use dynamic memory allocation, for example.<br>译文:<br>GNU C库允许您通过指定适当的hook函数来修改<code>malloc</code>、<code>realloc</code>和<code>free</code>的行为。例如，您可以使用这些hook来帮助调试使用动态内存分配的程序。</p>
</blockquote>
<p>malloc.h中声明了一些hook变量。它们的默认值是<code>0x0</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__malloc_hook</span><br><span class="line">__free_hook</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>因为它们用于帮助用户调试程序，所以它们在执行的时候是可写的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xf77228e0 &lt;__free_hook&gt;:       0x00000000</span><br><span class="line">0xf7722000 0xf7727000 rw-p      mapped</span><br></pre></td></tr></table></figure>
<p>这是malloc.c的<a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html" target="_blank" rel="noopener">源码</a>.下面我使用 <code>__libc_free</code>来演示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void (*hook) (void *, const void *) = atomic_forced_read (__free_hook);</span><br><span class="line">if (__builtin_expect (hook != NULL, 0))</span><br><span class="line">&#123;</span><br><span class="line">    (*hook)(mem, RETURN_ADDRESS (0));</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它检查<code>__free_hook</code>的值。如果不是NULL，它将首先调用hook函数。在这里，我们希望使用<strong>one-gadget-RCE</strong>。由于hook函数是在libc中调用的，所以通常满足<strong>one-gadget</strong>的constraints。</p>
<h2 id="Use-printf-to-trigger-malloc-and-free"><a href="#Use-printf-to-trigger-malloc-and-free" class="headerlink" title="Use printf to trigger malloc and free"></a>Use printf to trigger malloc and free</h2><p>查看<code>printf</code>函数的源码,有几个地方可能会触发<code>malloc</code>. 拿 <a href="https://code.woboq.org/userspace/glibc/stdio-common/vfprintf.c.html#1470" target="_blank" rel="noopener">vfprintf.c line 1470</a> 来做例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#define EXTSIZ 32</span><br><span class="line">enum &#123; WORK_BUFFER_SIZE = 1000 &#125;;</span><br><span class="line"></span><br><span class="line">if (width &gt;= WORK_BUFFER_SIZE - EXTSIZ)</span><br><span class="line">&#123;</span><br><span class="line">    /* 我们必须使用一个特殊的缓冲区。  */</span><br><span class="line">    size_t needed = ((size_t) width + EXTSIZ) * sizeof (CHAR_T);</span><br><span class="line">    if (__libc_use_alloca (needed))</span><br><span class="line">        workend = (CHAR_T *) alloca (needed) + width + EXTSIZ;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        workstart = (CHAR_T *) malloc (needed);</span><br><span class="line">        if (workstart == NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            done = -1;</span><br><span class="line">            goto all_done;</span><br><span class="line">        &#125;</span><br><span class="line">        workend = workstart + width + EXTSIZ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can find that <code>malloc</code> will be triggered if the width field is large enough.(Of course, <code>free</code> will also be triggered at the end of printf if <code>malloc</code> has been triggered.) However, WORK_BUFFER_SIZE is not large enough, since we need to go to <strong>else</strong> block. Let’s take a look at <code>__libc_use_alloca</code> and see what exactly the minimum size of width we should give.</p>
<p>我们可以发现，如果width field足够大，将触发<code>malloc</code>。(当然，如果<code>malloc</code>被触发，那么<code>free</code>也会在printf的末尾被触发。)但是，WORK_BUFFER_SIZE不够大，所以我们需要转到else块从而触发mallco。让我们看看<code>__libc_use_alloca</code>，看看应该给出的最小宽度是多少。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/* 线程的最小大小。我们可以自由选择一个合理的值  */</span><br><span class="line">#define PTHREAD_STACK_MIN        16384</span><br><span class="line"></span><br><span class="line">#define __MAX_ALLOCA_CUTOFF        65536</span><br><span class="line"></span><br><span class="line">int __libc_use_alloca (size_t size)</span><br><span class="line">&#123;</span><br><span class="line">    return (__builtin_expect (size &lt;= PTHREAD_STACK_MIN / 4, 1)</span><br><span class="line">        || __builtin_expect (__libc_alloca_cutoff (size), 1));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int __libc_alloca_cutoff (size_t size)</span><br><span class="line">&#123;</span><br><span class="line">	return size &lt;= (MIN (__MAX_ALLOCA_CUTOFF,</span><br><span class="line">					THREAD_GETMEM (THREAD_SELF, stackblock_size) / 4</span><br><span class="line">					/* 在初始化线程库之前，主线程在stackblock_size元素中为零。因为它是主线程，所以我们可以假设最大可用堆栈空间。  */</span><br><span class="line">					?: __MAX_ALLOCA_CUTOFF * 4));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们必须确保:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">size &gt; PTHREAD_STACK_MIN / 4</span><br><span class="line">size &gt; MIN(__MAX_ALLOCA_CUTOFF, THREAD_GETMEM(THREAD_SELF, stackblock_size) / 4 ?: __MAX_ALLOCA_CUTOFF * 4)</span><br></pre></td></tr></table></figure>
<ul>
<li>我并没有完全理解函数THREAD_GETMEM的作用，但它似乎主要返回0。</li>
<li>第二个条件通常是 <code>size &gt; 65536</code></li>
</ul>
<p>More details:</p>
<ul>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html" target="_blank" rel="noopener">__builtin_expect</a></li>
<li><a href="https://code.woboq.org/userspace/glibc/sysdeps/x86_64/nptl/tls.h.html#_M/THREAD_GETMEM" target="_blank" rel="noopener">THREAD_GETMEM</a></li>
</ul>
<h3 id="conclusion"><a href="#conclusion" class="headerlink" title="conclusion"></a>conclusion</h3><ul>
<li>触发<code>malloc</code>和<code>free</code>的最小宽度通常是65537。</li>
<li>If there is a Format String Vulnerability and the program ends right after calling <code>printf(buf)</code>, we can hijack <code>__malloc_hook</code> or <code>__free_hook</code> with <code>one-gadget</code> and use the trick mentioned above to trigger <code>malloc</code> &amp; <code>free</code> then we can still get the shell even there is no more function call or sth after <code>printf(buf)</code>.(如果有一个格式字符串漏洞,程序结束后调用printf(buf),我们可以用one-gadget劫持<code>__malloc_hook</code>或<code>__free_hook</code>,使用上面提到的技巧来触发<code>malloc</code>&amp;<code>free</code>然后我们仍然可以得到shell后没有更多的函数调用<code>printf(buf)</code>。)</li>
</ul>
<h2 id="Use-execveat-to-open-a-shell"><a href="#Use-execveat-to-open-a-shell" class="headerlink" title="Use execveat to open a shell"></a>Use execveat to open a shell</h2><p>提到用系统调用getshell时，我们会想到<code>execve</code>。但是，由于缺少gadgets或其他的constraints，通常并不是很容易就能办到。<br>有一个系统调用<code>execveat</code>，原型如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int execveat(int dirfd, const char *pathname,</span><br><span class="line">             char *const argv[], char *const envp[],</span><br><span class="line">             int flags);</span><br></pre></td></tr></table></figure>
<p>According to its <a href="http://man7.org/linux/man-pages/man2/execveat.2.html" target="_blank" rel="noopener">man page</a>, it operates in the same way as <code>execve</code>. As for the additional arguments, it mentions that:<br>根据<a href="http://man7.org/linux/man-pages/man2/execveat.2.html" target="_blank" rel="noopener">其手册</a>得知，它的运作方式与execve相同。至于其他不同点，它提到:</p>
<blockquote>
<p>If pathname is absolute, then dirfd is ignored.<br>如果路径名是绝对的，那么dirfd将被忽略。</p>
</blockquote>
<p>Hence, if we make <code>pathname</code> point to <code>/bin/sh</code>, and set <code>argv</code>, <code>envp</code> and <code>flags</code> to 0, we can still get a shell whatever the value of <code>dirfd</code>.<br>因此，如果我们让<code>pathname</code>为<code>/bin/sh</code>，并将<code>argv</code>、‘envp’和‘flags’设置为0，那么无论<code>dirfd</code>的值是多少，我们仍然可以getshell。</p>
<h1 id="原文-https-github-com-Naetw-CTF-pwn-tips"><a href="#原文-https-github-com-Naetw-CTF-pwn-tips" class="headerlink" title="原文:https://github.com/Naetw/CTF-pwn-tips"></a>原文:<a href="https://github.com/Naetw/CTF-pwn-tips" target="_blank" rel="noopener">https://github.com/Naetw/CTF-pwn-tips</a></h1><h1 id="译者-l0ser"><a href="#译者-l0ser" class="headerlink" title="译者:l0ser"></a>译者:l0ser</h1>
        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最終更新：<time datetime="2018-12-31T18:43:48.810Z" itemprop="dateUpdated">2019-01-01 02:43:48</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="http://zero-mk.github.io">
            <img src="/img/avatar.jpg" alt="">
            
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf-pwn/">ctf-pwn</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://zero-mk.github.io/2018/12/31/CTF-pwn-tips-zh_CN/&title=《ctf-pwn-tips-zh_CN》 — l0ser&pic=http://zero-mk.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://zero-mk.github.io/2018/12/31/CTF-pwn-tips-zh_CN/&title=《ctf-pwn-tips-zh_CN》 — l0ser&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://zero-mk.github.io/2018/12/31/CTF-pwn-tips-zh_CN/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《ctf-pwn-tips-zh_CN》 — l0ser&url=http://zero-mk.github.io/2018/12/31/CTF-pwn-tips-zh_CN/&via=http://zero-mk.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://zero-mk.github.io/2018/12/31/CTF-pwn-tips-zh_CN/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/01/01/pwntools-Command Line Tools/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">pwntools的命令行工具pwn</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/12/20/syscall/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Linux_System_Call_Table</h4>
      </a>
    </div>
  
</nav>



    

















</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>このブログの内容物は<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ja">クリエイティブ・コモンズ 表示 - 非営利 - 継承 4.0 国際ライセンスの下に提供されています</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span> &copy; 2015 - 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://zero-mk.github.io/2018/12/31/CTF-pwn-tips-zh_CN/&title=《ctf-pwn-tips-zh_CN》 — l0ser&pic=http://zero-mk.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://zero-mk.github.io/2018/12/31/CTF-pwn-tips-zh_CN/&title=《ctf-pwn-tips-zh_CN》 — l0ser&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://zero-mk.github.io/2018/12/31/CTF-pwn-tips-zh_CN/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《ctf-pwn-tips-zh_CN》 — l0ser&url=http://zero-mk.github.io/2018/12/31/CTF-pwn-tips-zh_CN/&via=http://zero-mk.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://zero-mk.github.io/2018/12/31/CTF-pwn-tips-zh_CN/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACK0lEQVR42u3aS07EMBAFQO5/adiCIMN77YAUu7IaDZnYlUXj/ry9xdf7xfX6r9/v/Hz/1efv9992YWBgPJaRLJ8scPWr1/dc7SHfGwYGxjmMq23lYbHdXB7KX+8NAwMDo2W0VxuyMTAwMBJG9NDgzuQAioGBgdEmsbPgm3zzr7k4BgbGAxmzQPk/n/+kv4GBgfEoxizhnAXle3fyZXUMDIytGbNl2tQ0aQa0KTEGBsY5jDbJXBm8uHc4Y1jDw8DAeCAjL/GvBMe28Zkgf+FhYGBsxJg1C1eOiclrqktvGBgYBzDyR+Thcv3FFcU7DAyMrRlJUFsZ5EqKbvmKRUaOgYGxHeMvmo7ttmb4y/8hGBgYWzPuCqY59ebmBAYGxtaMvHyfF8sS5F1dSAwMjHMYyVEsD81tAW7lGwwMjL0ZbbhsByzyV9Cmrz/M4WJgYGzNmB0T8xHVttDWHjQxMDB2ZdwV/vKWZ35wLAI0BgbG1ozXYTFvOtaFsDKhTVbHwMA4h9GGv5Vkdb1g98sBEQMDYzvGrLg2OyC2Rb2i+4qBgXEAIx/8Gg5slbDiVxgYGJsy3strpVXZbq6gYmBgbM1oC2ErJbn8Ba03ODEwMPZj3DUSkTcv21eWHFUxMDBOYKwXv9oxsvYQGQ1bYGBgYJSFs7Yt2jYPhj0KDAyMYxiz5WfDZFGYxsDAOIDRFtSSBHXWYJg1QTEwMPZm5KljfuBrn5mH5tlaGBgYj2V8AKGsS6mgPSueAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'l0ser blog';
            clearTimeout(titleTime);
        } else {
            document.title = 'l0ser blog';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
